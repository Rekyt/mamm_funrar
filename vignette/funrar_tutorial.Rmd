---
title: "How to compute functional rarity indices using `funrar`"
author: "Matthias Greni√©"
date: "21 mai 2018"
output: pdf_document
bibliography: references.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This document aims to guide you through the use of `funrar` to compute functional rarity indices.
The aim is to reproduce the analyses from [@Grenie_funrar_2017] by using the Mammals dataset published on Dryad [@Lawing_Data_2016] from [@Lawing_Community_2017]. We are going to describe the functional rarity of North American mammals from atlas data.
Before running the analysis be sure to install the different packages and download the needed datasets by running the following chunk:

```{r, eval = FALSE}

# Install package `devtools` to install development version of `funrar`
if (!require("devtools")) {
    install.packages("devtools")
}

# Install development version of funrar
devtools::install_github("Rekyt/funrar", build_vignettes = TRUE)

# Install development version of `rdryad` if missing to download the example
# dataset
devtools::install_github("ropensci/rdryad")

# Install `ggplot2` if missing
if (!require("ggplot2")) {
    install.packages("ggplot2")
}

# Create a tutorial directory in the current directory
if (!dir.exists("funrar_tutorial")) {
    dir.create("funrar_tutorial")
}

# Move to tutorial directory
setwd("funrar_tutorial")

if (!dir.exists("data")) {
    dir.create("data")
}

# Download the example dataset from Lawning et al. 2016
# <doi:10.5061/dryad.9t0n8>
tempfile("data/lawning_data.zip")
rdryad::dryad_fetch(
    rdryad::dryad_files(rdryad::handle2doi("10255/dryad.116171"))[1],
    destfile = "data/lawning_data.zip", mode = "wb")
unzip("data/lawning_data.zip", exdir = "data")
unlink("data/lawning_data.zip")
```

## Load Data

Now that all the necessary packages are installed and the example dataset
downloaded, we can begin by loading and describing the files in the archive.
@Lawing_Data_2016 mentioned in its an atlas dataset of North American mammals.
The trait matrix is in the `Traits.csv` file. It contains the trait information for all the mammal from the @Jones_PanTHERIA_2009 database.

```{r}
trait_matrix = read.csv("data/DryadArchive/Traits.csv")

head(trait_matrix)
summary(trait_matrix)
```
This table contains the traits of species from the @Jones_PanTHERIA_2009 database, with only quantitative traits.
In order to compute functional rarity we need to choose a subset of traits to keep a high number of species while using enough traits to estimate functional rarity. In order to get similar results to [@Grenie_funrar_2017], we select the following traits: adult body mass, litter size, diest breadth, habitat breadth and terrestriality.
```{r}
# Filter observation that are not NA in the selected columns
trait_subset = subset(trait_matrix, !is.na(trait_matrix$X5_1_AdultBodyMass_g) &
                          !is.na(trait_matrix$X15_1_LitterSize) &
                          !is.na(trait_matrix$X6_1_DietBreadth) &
                          !is.na(trait_matrix$X6_2_TrophicLevel) &
                          !is.na(trait_matrix$X12_1_HabitatBreadth) &
                          !is.na(trait_matrix$X12_2_Terrestriality))

# Conserve only the necessary columns
trait_subset = trait_subset[, colSums(is.na(trait_subset)) == 0]

head(trait_subset)
```

Then we need to load one `PresAbsMatrixXXX.csv` file, which contains the presence-absence matrix with the different species. To make computation quicker and avoid clogging the RAM, we load the coarser resolution presence-absence matrix `PresAbsMatrix250.csv`.

```{r}
pres_matrix = read.csv("data/DryadArchive/PresAbsMatrix250.csv")

pres_matrix[1:5, 1:5]
```

We need then to select only species for which we have traits:
```{r}
# Select only the subset species for which we have selected the traits
pres_subset = pres_matrix[, c("GlobalID", "Longitude", "Latitude"),
                          gsub(" ", "_", trait_subset$TaxonName)]
```


## Compute distance matrix

Now that we have loaded the data and selected the traits, we can compute the functional distance/dissimilarity matrix that will be used in the computation of functional rarity indices.

Before computing the distance matrix we have to make sure that the trait matrix is well formatted, with row names corresponding to species names and with only traits needed for distance matrices.

```{r format_traits}
library("funrar")

trait_format = trait_subset
rownames(trait_format) = gsub(" ", "_", trait_format$TaxonName)
trait_format = trait_format[, -1]

trait_distance = compute_dist_matrix(trait_format, metric = "gower")
```

The `compute_dist_matrix()` function is a wrapper around the `daisy()` function in package `cluster`. By default it computes Gower's distance [-@Gower_General_1971], but the distance can be changed using the `metric` argument. For example to compute euclidean trait distance, it is possible to use `compute_dist_matrix(metric = "euclidean")`.
Otherwise any distance/dissimilarity method can used as long as the distance matrix is of `matrix` type with column and row names corresponding to species/individual/genotype names.

When working with mixed traits (continuous, discrete, ordinal, nominal and others), another distance metric that can be considered is the extended Gower distance [@Pavoine_challenge_2009], computable using the `dist.ktab()` function of the `ade4` package.

**WARNING:** Make sure that column types correspond to trait values before
computing distances (ordinal traits as `ordered` factor for example).

## Compute rarity indices

### Notes on format

In `funrar` all the functions to compute rarity indices are provided in two format depending on the presence-absence matrix.
The presence-absence data can be provided as a matrix using the "regular" version of functions. The most common format is a presence-absence matrix, such a matrix can be difficult to load using R. It has recently been suggested that the "tidy" format should be used to structure data [@JSSv059i10]. In tidy format, the site-species matrix has three columns: one for species, one for site and one for abundances, each row is an observation of a given species in a given site with a given abundance.

![Matrix to tidy format. **(left)** Matrix format for site-species table **(right)** tidy format for site-species table]("matrix_to_tidy.png")

All indices functions exist in a regular form that uses the matrix format. All of them exist in a tidy or stack version using a suffix `_stack()` (and `_tidy()`).

### Distinctiveness (Local Trait Rarity)

The `funrar` package computes the indices following [@Violle_Functional_2017]. Thus functional distinctiveness, i.e., the local trait rarity is defined as follow:
$$
D_i = \frac{
        \sum_{j = 1, j \neq i}^{N} d_{ij}
        }{N-1}
$$
with $i$ the focal species, $N$ the total number of species in the given community and $d_{ij}$ the dissimarity/distance coefficient between species $i$ and $j$.
When using abundances the functional distinctiveness is defied as:
$$
D_{i, ab} = \frac{
        \sum_{j = 1, j \neq i}^{N} d_{ij} \times A_j
        }{\sum_{j = 1, j \neq i}^{N} A_j}
$$
with $A_j$ the relative abundance of species $j$ the focal community.

In the package the matrix version of the function `distinctiveness()` computes distinctiveness:

```{r compute_distinctiveness}
# The site-species matrix should be formatted beforehand
pres_mat = pres_matrix
rownames(pres_mat) = pres_mat$GlobalID  # Name sites
pres_mat = pres_mat[, -c(1:3)]          # Take out sites and coordinates
pres_mat = as.matrix(pres_mat)

mamm_di = distinctiveness(pres_mat, trait_distance)

str(mamm_di)
```
Returned object is a `matrix`, with `NA` when species is absent of the community. The warning message tells use that some communities had a single species them, thus they had `NaN`.
Either you can use the matrix format or transform it to a data frame using the `matrix_to_stack()` function where you indicate the name of the column that will contain the values, one for the row names and one for the column names:

```{r}
df_di = matrix_to_stack(mamm_di,
                        value_col  = "di",      # Name of the column with values
                        row_to_col = "site",    # Name of column with row names
                        col_to_col = "species") # Name of column with col names
```


### Uniqueness (Regional Trait Rarity)

### Scarcity (Local Geographical Rarity)

### Restrictedness (Regional Geographical Rarity)

### Other notes

Global Di computation, Local Ui computation,

Performance sparse matrices.

Other ways of computing Ri

## Visualization

Indices distribution
Indices correlations
Functional Space
Maps

## References
