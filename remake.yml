packages:
    - dplyr
    - rgdal
    - maptools
    - raster
    - ggplot2
    - knitr

sources:
    - remake_scripts

targets:
    all:
        depends:
        - results/exploratory_analysis.pdf

    # Download data
    dryad_dataset:
        command: download_lawing_2015()
        packages: rdryad

    shapefile_grid:
        command: download_shapefile_grid()


    # Treat trait and presence-absence matrix
    raw_mammal_traits:
        command: read.csv("data/raw/dryad.116171/DryadArchive/Traits.csv")
        depends: dryad_dataset

    raw_pres_mat:
        command: read.csv("data/raw/dryad.116171/DryadArchive/PresAbsMatrix50.csv")
        depends: dryad_dataset

    subset_traits:
        command: select_traits(raw_mammal_traits)

    subset_pres:
        command: get_common_species(raw_pres_mat, subset_traits)

    subset_iucn_status:
        command: get_iucn_status(subset_traits)
        packages:
            - taxize
            - doParallel

    pres_matrix:
        command: format_presence_matrix(subset_pres)

    trait_df:
        command: format_trait(subset_traits)

    dist_matrix:
        command: compute_dist_matrix(trait_df)
        packages:
            - funrar

    mammal_funrar:
        command: compute_funrar(pres_matrix, subset_traits)
        packages:
            - funrar
            - Matrix

    null_shuffled_matrix:
        command: compute_null_funrar(pres_matrix, dist_matrix)
        packages:
            - funrar
            - vegan

    null_shuffled_traits:
        command: compute_null_traits(pres_matrix, trait_df)
        packages:
            - funrar

    null_flat_ui:
        command: flatten_null_uniqueness(null_shuffled_traits, mammal_funrar)

    # Make figures
    background_grid:
        command: get_spatial_grid("data/raw/Continent Shapefiles/NorthAmerica.shp")
        depends: shapefile_grid

    raster_grid:
        command: rasterize_vector_grid(background_grid)

    richness_map:
        command: draw_richness_map(subset_pres)
        packages: ggthemes

    # Make document

    results/exploratory_analysis.pdf:
        command: render("results/exploratory_analysis.Rmd", I("pdf_document"))
        depends:
            - mammal_funrar
            - subset_pres
            - subset_iucn_status
            - null_shuffled_matrix
            - null_flat_ui
        packages: rmarkdown

